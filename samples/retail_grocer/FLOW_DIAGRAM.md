# Retail Grocer: Power BI â†” Snowflake Multi-Domain Flow

## Visual Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸŸ¦ MICROSOFT SIDE              â”‚         â”‚                    â„ï¸ SNOWFLAKE SIDE                             â”‚
â”‚          (Power BI / Fabric)             â”‚         â”‚                   (Cortex / Warehouse)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ‘¤ User asks in Power BI Copilot  â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  "Why did margin drop in Scotland?"â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                    â”‚                     â”‚         â”‚                                                                  â”‚
â”‚                    â–¼                     â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚      ğŸ“Š TMDL Semantic Models       â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚      (DAX measures, tables)        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ“ˆ Sales_Revenue.tmdl             â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ TotalSales, LFLSales         â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ GrossMarginPct, ATV          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ“¦ Inventory_Supply.tmdl          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ StockTurn, InStockRate       â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ DaysOfSupply, OTIF           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ‘¥ Customer_Loyalty.tmdl          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ CLV, RetentionRate           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ LoyaltyPenetration           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ·ï¸ Promotions_Pricing.tmdl        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ PromoROI, PromoLift          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ DiscountDepth                â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸª Store_Operations.tmdl          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ Footfall, Conversion         â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ WasteRate, LabourCost        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                    â”‚                     â”‚         â”‚                                                                  â”‚
â”‚                    â–¼                     â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     ğŸ¤– MS Fabric Agent             â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  "Query needs Snowflake data for   â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   warehouse-level analysis..."     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚          â”‚                                                       â”‚
â”‚                                          â”‚         â”‚          â–¼                                                       â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚                                          â”‚         â”‚  â”‚ ğŸ”’ AGENT      â”‚                                               â”‚
â”‚                                          â”‚         â”‚  â”‚   GATEWAY     â”‚                                               â”‚
â”‚                                          â”‚         â”‚  â”‚ (Auth/Audit)  â”‚                                               â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                          â”‚         â”‚          â”‚                                                       â”‚
â”‚                                          â”‚         â”‚          â–¼                                                       â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                          â”‚         â”‚  â”‚              ğŸ”€ DOMAIN ROUTER (Cortex)                     â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚   "Margin in Scotland â†’ needs Sales + Promo + Ops"         â”‚  â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚         â”‚         â”‚              â”‚              â”‚                          â”‚
â”‚                                          â”‚         â”‚         â–¼              â–¼              â–¼                          â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                          â”‚         â”‚  â”‚ ğŸ“Š Sales   â”‚ â”‚ ğŸ·ï¸ Promo   â”‚ â”‚ ğŸª Ops     â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚ Cortex SV  â”‚ â”‚ Cortex SV  â”‚ â”‚ Cortex SV  â”‚ â† YAML format      â”‚
â”‚                                          â”‚         â”‚  â”‚ (YAML)     â”‚ â”‚ (YAML)     â”‚ â”‚ (YAML)     â”‚                    â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                          â”‚         â”‚        â”‚              â”‚              â”‚                          â”‚
â”‚                                          â”‚         â”‚        â–¼              â–¼              â–¼                          â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                          â”‚         â”‚  â”‚ ğŸ¤– Sales   â”‚ â”‚ ğŸ¤– Promo   â”‚ â”‚ ğŸ¤– Ops     â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚   Agent    â”‚ â”‚   Agent    â”‚ â”‚   Agent    â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚ "Margin    â”‚ â”‚ "PromoMix  â”‚ â”‚ "Waste up  â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚  23.4% vs  â”‚ â”‚  +12% vs   â”‚ â”‚  +0.4% in  â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚  25% tgt"  â”‚ â”‚  plan"     â”‚ â”‚  fresh"    â”‚                    â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                          â”‚         â”‚        â”‚              â”‚              â”‚                          â”‚
â”‚                                          â”‚         â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                          â”‚         â”‚                       â–¼                                         â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                          â”‚         â”‚  â”‚                ğŸ‘” SUPERVISOR AGENT                         â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚                                                            â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚   SYNTHESIZES:                                             â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚   "Margin dropped in Scotland due to:                      â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚    1. Heavy promotional activity (PromoMix +12%)           â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚    2. Fresh category waste increased (+0.4%)               â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚    3. Labour overtime during refit period (+Â£45k)"         â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚     ğŸ“Š Power BI Renderer           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚                                    â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  Generates visualization:          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  â€¢ Margin waterfall chart          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  â€¢ Regional heatmap                â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  â€¢ Driver breakdown table          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                    â”‚                     â”‚         â”‚                                                                  â”‚
â”‚                    â–¼                     â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ’¬ Response to User               â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚                                    â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  "Margin was 23.4% vs 25% target.  â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   Key drivers:                     â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   â€¢ Promo depth increased 12%      â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   â€¢ Fresh waste up in 8 stores     â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   â€¢ Labour overtime during refit   â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚                                    â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   [ğŸ“Š View Margin Analysis]        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   [ğŸ“ˆ Open in Power BI]"           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                                          â”‚         â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Concepts

### 1. Dual Semantic Layer

| Aspect | Power BI (TMDL) | Snowflake (Cortex YAML) |
|--------|-----------------|-------------------------|
| **Format** | TMDL / DAX | YAML |
| **Measures** | DAX expressions | SQL expressions |
| **Location** | Microsoft Fabric | Snowflake Stage |
| **Runtime** | Power BI Engine | Cortex Analyst |
| **Visualization** | Native PBI visuals | Returns to PBI |

### 2. Agent Roles

| Agent | Platform | Responsibility |
|-------|----------|----------------|
| **PBI Copilot** | Microsoft | Entry point, simple queries |
| **MS Fabric Agent** | Microsoft | Orchestrates PBI side, initiates handoff |
| **Agent Gateway** | Shared | Auth, audit, governance |
| **Domain Router** | Snowflake | Routes to relevant domains |
| **Domain Agents** (5) | Snowflake | Query specific semantic views |
| **Supervisor** | Snowflake | Synthesize multi-domain findings |
| **PBI Renderer** | Microsoft | Generate visualizations |

### 3. When Does Handoff Happen?

**Stay in Power BI** (no handoff):
- Simple metric lookups ("What was last week's sales?")
- Pre-built dashboard navigation
- Single-domain, single-measure queries

**Handoff to Snowflake** when:
- Cross-domain analysis needed ("Why did X affect Y?")
- Real-time data required (PBI has stale snapshot)
- Complex multi-step reasoning
- Access to data not replicated to PBI

### 4. Data Flow Summary

```
1. USER â†’ PBI Copilot: "Why did margin drop in Scotland?"
   
2. PBI Copilot â†’ Checks TMDL models
   â†³ Basic answer available? â†’ Respond directly
   â†³ Needs deeper analysis? â†’ Continue to step 3

3. MS Fabric Agent â†’ Agent Gateway â†’ Snowflake Router
   â†³ Packages: query, context, user permissions
   â†³ Gateway validates auth, logs request

4. Domain Router â†’ Identifies: Sales + Promo + Ops needed
   â†³ Parallel dispatch to 3 domain agents

5. Domain Agents â†’ Query Cortex Semantic Views
   â†³ Sales Agent: "Margin 23.4% vs 25%"
   â†³ Promo Agent: "PromoMix +12%"
   â†³ Ops Agent: "Waste +0.4%, OT +Â£45k"

6. Supervisor â†’ Synthesizes findings
   â†³ "Margin down due to: promo activity, waste, overtime"

7. Supervisor â†’ PBI Renderer
   â†³ Data formatted for visualization

8. PBI Renderer â†’ Generates chart
   â†³ Margin waterfall, regional heatmap

9. Response â†’ User
   â†³ Text insight + embedded visualization
```

## Why This Architecture?

1. **Best of Both Worlds**
   - Power BI's rich visualization + Snowflake's compute power
   - TMDL for business-friendly measures + YAML for enterprise governance

2. **Separation of Concerns**
   - Microsoft owns visualization layer
   - Snowflake owns data processing layer
   - Clear handoff points with audit trail

3. **Domain Expertise**
   - Each domain agent is specialized (Sales knows margin, Ops knows waste)
   - Supervisor connects the dots across domains

4. **Governance**
   - Agent Gateway enforces policies
   - Both platforms maintain their own semantic models
   - Audit trail of all cross-platform queries



## Visual Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸŸ¦ MICROSOFT SIDE              â”‚         â”‚                    â„ï¸ SNOWFLAKE SIDE                             â”‚
â”‚          (Power BI / Fabric)             â”‚         â”‚                   (Cortex / Warehouse)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ‘¤ User asks in Power BI Copilot  â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  "Why did margin drop in Scotland?"â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                    â”‚                     â”‚         â”‚                                                                  â”‚
â”‚                    â–¼                     â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚      ğŸ“Š TMDL Semantic Models       â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚      (DAX measures, tables)        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ“ˆ Sales_Revenue.tmdl             â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ TotalSales, LFLSales         â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ GrossMarginPct, ATV          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ“¦ Inventory_Supply.tmdl          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ StockTurn, InStockRate       â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ DaysOfSupply, OTIF           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ‘¥ Customer_Loyalty.tmdl          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ CLV, RetentionRate           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ LoyaltyPenetration           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ·ï¸ Promotions_Pricing.tmdl        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ PromoROI, PromoLift          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ DiscountDepth                â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸª Store_Operations.tmdl          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ Footfall, Conversion         â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     â€¢ WasteRate, LabourCost        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                    â”‚                     â”‚         â”‚                                                                  â”‚
â”‚                    â–¼                     â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚     ğŸ¤– MS Fabric Agent             â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  "Query needs Snowflake data for   â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   warehouse-level analysis..."     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚          â”‚                                                       â”‚
â”‚                                          â”‚         â”‚          â–¼                                                       â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚                                          â”‚         â”‚  â”‚ ğŸ”’ AGENT      â”‚                                               â”‚
â”‚                                          â”‚         â”‚  â”‚   GATEWAY     â”‚                                               â”‚
â”‚                                          â”‚         â”‚  â”‚ (Auth/Audit)  â”‚                                               â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                          â”‚         â”‚          â”‚                                                       â”‚
â”‚                                          â”‚         â”‚          â–¼                                                       â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                          â”‚         â”‚  â”‚              ğŸ”€ DOMAIN ROUTER (Cortex)                     â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚   "Margin in Scotland â†’ needs Sales + Promo + Ops"         â”‚  â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚         â”‚         â”‚              â”‚              â”‚                          â”‚
â”‚                                          â”‚         â”‚         â–¼              â–¼              â–¼                          â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                          â”‚         â”‚  â”‚ ğŸ“Š Sales   â”‚ â”‚ ğŸ·ï¸ Promo   â”‚ â”‚ ğŸª Ops     â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚ Cortex SV  â”‚ â”‚ Cortex SV  â”‚ â”‚ Cortex SV  â”‚ â† YAML format      â”‚
â”‚                                          â”‚         â”‚  â”‚ (YAML)     â”‚ â”‚ (YAML)     â”‚ â”‚ (YAML)     â”‚                    â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                          â”‚         â”‚        â”‚              â”‚              â”‚                          â”‚
â”‚                                          â”‚         â”‚        â–¼              â–¼              â–¼                          â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                          â”‚         â”‚  â”‚ ğŸ¤– Sales   â”‚ â”‚ ğŸ¤– Promo   â”‚ â”‚ ğŸ¤– Ops     â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚   Agent    â”‚ â”‚   Agent    â”‚ â”‚   Agent    â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚ "Margin    â”‚ â”‚ "PromoMix  â”‚ â”‚ "Waste up  â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚  23.4% vs  â”‚ â”‚  +12% vs   â”‚ â”‚  +0.4% in  â”‚                    â”‚
â”‚                                          â”‚         â”‚  â”‚  25% tgt"  â”‚ â”‚  plan"     â”‚ â”‚  fresh"    â”‚                    â”‚
â”‚                                          â”‚         â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                          â”‚         â”‚        â”‚              â”‚              â”‚                          â”‚
â”‚                                          â”‚         â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                          â”‚         â”‚                       â–¼                                         â”‚
â”‚                                          â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                          â”‚         â”‚  â”‚                ğŸ‘” SUPERVISOR AGENT                         â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚                                                            â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚   SYNTHESIZES:                                             â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚   "Margin dropped in Scotland due to:                      â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚    1. Heavy promotional activity (PromoMix +12%)           â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚    2. Fresh category waste increased (+0.4%)               â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚    3. Labour overtime during refit period (+Â£45k)"         â”‚  â”‚
â”‚                                          â”‚         â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚     ğŸ“Š Power BI Renderer           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚                                    â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  Generates visualization:          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  â€¢ Margin waterfall chart          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  â€¢ Regional heatmap                â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  â€¢ Driver breakdown table          â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                    â”‚                     â”‚         â”‚                                                                  â”‚
â”‚                    â–¼                     â”‚         â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  ğŸ’¬ Response to User               â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚                                    â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚  "Margin was 23.4% vs 25% target.  â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   Key drivers:                     â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   â€¢ Promo depth increased 12%      â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   â€¢ Fresh waste up in 8 stores     â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   â€¢ Labour overtime during refit   â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚                                    â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   [ğŸ“Š View Margin Analysis]        â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â”‚   [ğŸ“ˆ Open in Power BI]"           â”‚  â”‚         â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                                                                  â”‚
â”‚                                          â”‚         â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Concepts

### 1. Dual Semantic Layer

| Aspect | Power BI (TMDL) | Snowflake (Cortex YAML) |
|--------|-----------------|-------------------------|
| **Format** | TMDL / DAX | YAML |
| **Measures** | DAX expressions | SQL expressions |
| **Location** | Microsoft Fabric | Snowflake Stage |
| **Runtime** | Power BI Engine | Cortex Analyst |
| **Visualization** | Native PBI visuals | Returns to PBI |

### 2. Agent Roles

| Agent | Platform | Responsibility |
|-------|----------|----------------|
| **PBI Copilot** | Microsoft | Entry point, simple queries |
| **MS Fabric Agent** | Microsoft | Orchestrates PBI side, initiates handoff |
| **Agent Gateway** | Shared | Auth, audit, governance |
| **Domain Router** | Snowflake | Routes to relevant domains |
| **Domain Agents** (5) | Snowflake | Query specific semantic views |
| **Supervisor** | Snowflake | Synthesize multi-domain findings |
| **PBI Renderer** | Microsoft | Generate visualizations |

### 3. When Does Handoff Happen?

**Stay in Power BI** (no handoff):
- Simple metric lookups ("What was last week's sales?")
- Pre-built dashboard navigation
- Single-domain, single-measure queries

**Handoff to Snowflake** when:
- Cross-domain analysis needed ("Why did X affect Y?")
- Real-time data required (PBI has stale snapshot)
- Complex multi-step reasoning
- Access to data not replicated to PBI

### 4. Data Flow Summary

```
1. USER â†’ PBI Copilot: "Why did margin drop in Scotland?"
   
2. PBI Copilot â†’ Checks TMDL models
   â†³ Basic answer available? â†’ Respond directly
   â†³ Needs deeper analysis? â†’ Continue to step 3

3. MS Fabric Agent â†’ Agent Gateway â†’ Snowflake Router
   â†³ Packages: query, context, user permissions
   â†³ Gateway validates auth, logs request

4. Domain Router â†’ Identifies: Sales + Promo + Ops needed
   â†³ Parallel dispatch to 3 domain agents

5. Domain Agents â†’ Query Cortex Semantic Views
   â†³ Sales Agent: "Margin 23.4% vs 25%"
   â†³ Promo Agent: "PromoMix +12%"
   â†³ Ops Agent: "Waste +0.4%, OT +Â£45k"

6. Supervisor â†’ Synthesizes findings
   â†³ "Margin down due to: promo activity, waste, overtime"

7. Supervisor â†’ PBI Renderer
   â†³ Data formatted for visualization

8. PBI Renderer â†’ Generates chart
   â†³ Margin waterfall, regional heatmap

9. Response â†’ User
   â†³ Text insight + embedded visualization
```

## Why This Architecture?

1. **Best of Both Worlds**
   - Power BI's rich visualization + Snowflake's compute power
   - TMDL for business-friendly measures + YAML for enterprise governance

2. **Separation of Concerns**
   - Microsoft owns visualization layer
   - Snowflake owns data processing layer
   - Clear handoff points with audit trail

3. **Domain Expertise**
   - Each domain agent is specialized (Sales knows margin, Ops knows waste)
   - Supervisor connects the dots across domains

4. **Governance**
   - Agent Gateway enforces policies
   - Both platforms maintain their own semantic models
   - Audit trail of all cross-platform queries








